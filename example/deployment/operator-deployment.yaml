---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.0
  name: permissionbinders.permission.permission-binder.io
spec:
  group: permission.permission-binder.io
  names:
    kind: PermissionBinder
    listKind: PermissionBinderList
    plural: permissionbinders
    singular: permissionbinder
  scope: Namespaced
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        description: PermissionBinder is the Schema for the permissionbinders API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: PermissionBinderSpec defines the desired state of PermissionBinder
            properties:
              configMapName:
                description: ConfigMapName is the name of the ConfigMap to watch for
                  changes
                type: string
              configMapNamespace:
                description: ConfigMapNamespace is the namespace where the ConfigMap
                  is located
                type: string
              createLdapGroups:
                default: false
                description: CreateLdapGroups enables automatic LDAP group creation
                  for namespaces
                type: boolean
              excludeList:
                description: ExcludeList contains CN values to exclude from processing
                items:
                  type: string
                type: array
              ldapSecretRef:
                description: |-
                  LdapSecretRef references a Secret containing LDAP connection credentials
                  Required keys: domain_server, domain_username, domain_password
                properties:
                  name:
                    description: Name of the Secret containing LDAP credentials
                    type: string
                  namespace:
                    description: Namespace of the Secret containing LDAP credentials
                    type: string
                required:
                - name
                - namespace
                type: object
              ldapTlsVerify:
                default: true
                description: |-
                  LdapTlsVerify enables TLS certificate verification for LDAPS connections
                  Set to false to skip certificate verification (insecure, for testing only)
                type: boolean
              networkPolicy:
                description: NetworkPolicy configuration for GitOps-based Network
                  Policy management
                properties:
                  autoMerge:
                    description: AutoMerge configuration for auto-merge labels
                    properties:
                      enabled:
                        default: true
                        description: Enabled enables auto-merge labels
                        type: boolean
                      label:
                        default: auto-merge
                        description: |-
                          Label is the label added to PRs for auto-merge
                          Only added for Variant A (new file from template)
                        type: string
                    type: object
                  backupExisting:
                    default: false
                    description: |-
                      BackupExisting enables backup of existing NetworkPolicies from cluster to Git
                      Default: false (safe - does not conflict with other GitOps tools)
                    type: boolean
                  batchProcessing:
                    description: BatchProcessing configuration for batch processing
                      of namespaces
                    properties:
                      batchSize:
                        default: 5
                        description: |-
                          BatchSize is the number of namespaces processed in each batch
                          Default: 5
                        type: integer
                      sleepBetweenBatches:
                        default: 60s
                        description: |-
                          SleepBetweenBatches is the sleep duration between batches
                          Default: "60s" (GitOps sync delay - allows GitOps to apply changes)
                        type: string
                      sleepBetweenNamespaces:
                        default: 3s
                        description: |-
                          SleepBetweenNamespaces is the sleep duration between namespaces within a batch
                          Default: "3s" (Git API rate limiting)
                        type: string
                    type: object
                  enabled:
                    default: false
                    description: Enabled enables Network Policy management via GitOps
                    type: boolean
                  excludeBackupForNamespaces:
                    description: |-
                      ExcludeBackupForNamespaces is a per-namespace exclude list for backup operations only
                      If a namespace is in this list, operator will NOT backup existing policies (Variants B/C)
                      but will STILL create policies from templates (Variant A)
                    properties:
                      explicit:
                        description: |-
                          Explicit is a list of explicit namespace names to exclude
                          Example: ["default", "kube-system"]
                        items:
                          type: string
                        type: array
                      patterns:
                        description: |-
                          Patterns are regex patterns for excluding namespaces
                          Example: ["^openshift-.*", "^ocp-.*", "^kube-.*"]
                        items:
                          type: string
                        type: array
                    type: object
                  excludeNamespaces:
                    description: |-
                      ExcludeNamespaces is a global exclude list that blocks ALL NetworkPolicy operations
                      If a namespace is in this list, operator will NOT create policies from templates
                      and will NOT backup existing policies
                    properties:
                      explicit:
                        description: |-
                          Explicit is a list of explicit namespace names to exclude
                          Example: ["default", "kube-system"]
                        items:
                          type: string
                        type: array
                      patterns:
                        description: |-
                          Patterns are regex patterns for excluding namespaces
                          Example: ["^openshift-.*", "^ocp-.*", "^kube-.*"]
                        items:
                          type: string
                        type: array
                    type: object
                  gitRepository:
                    description: GitRepository configuration for GitOps repository
                    properties:
                      apiBaseURL:
                        description: |-
                          APIBaseURL is the API base URL for self-hosted Git servers
                          Optional - auto-detected from URL if not provided
                          Examples:
                            - Bitbucket: https://git.cembraintra.ch/rest/api/1.0
                            - GitHub: https://git.cembraintra.ch/api/v3
                            - GitLab: https://git.cembraintra.ch/api/v4
                        type: string
                      baseBranch:
                        description: BaseBranch is the base branch for PRs (typically
                          "main" or "master")
                        type: string
                      clusterName:
                        description: |-
                          ClusterName is the cluster name used in Git repository paths
                          Example: "DEV-cluster" -> networkpolicies/DEV-cluster/...
                        type: string
                      credentialsSecretRef:
                        description: |-
                          CredentialsSecretRef references a Secret containing Git credentials
                          Required keys: token (and optionally username, email)
                        properties:
                          name:
                            description: Name of the Secret containing LDAP credentials
                            type: string
                          namespace:
                            description: Namespace of the Secret containing LDAP credentials
                            type: string
                        required:
                        - name
                        - namespace
                        type: object
                      gitTlsVerify:
                        default: true
                        description: |-
                          GitTlsVerify enables TLS certificate verification for Git HTTPS connections
                          Set to false to skip certificate verification (insecure, for self-signed certs only)
                          Default: true (secure)
                        type: boolean
                      provider:
                        description: |-
                          Provider is the Git provider (bitbucket, github, gitlab)
                          Optional for public providers (auto-detected from URL)
                          Required for self-hosted Git servers (e.g., git.cembraintra.ch)
                        enum:
                        - bitbucket
                        - github
                        - gitlab
                        type: string
                      url:
                        description: URL is the Git repository URL (HTTPS)
                        type: string
                    required:
                    - baseBranch
                    - clusterName
                    - credentialsSecretRef
                    - url
                    type: object
                  reconciliationInterval:
                    default: 1h
                    description: |-
                      ReconciliationInterval is the interval for periodic reconciliation (drift detection)
                      Default: "1h" (can be set to "4h" to avoid overwhelming etcd)
                    type: string
                  stalePRThreshold:
                    default: 30d
                    description: |-
                      StalePRThreshold is the threshold for marking PRs as stale (duration string)
                      Default: "30d" (30 days)
                    type: string
                  statusRetentionDays:
                    default: 30
                    description: |-
                      StatusRetentionDays is the number of days to retain status entries for removed namespaces
                      Default: 30 days
                    type: integer
                  templateDir:
                    description: |-
                      TemplateDir is the directory path in Git repository containing Network Policy templates
                      All .yaml files in this directory are treated as templates
                      Example: "networkpolicies/templates"
                    type: string
                type: object
              prefixes:
                description: |-
                  Prefixes used to identify permission strings (e.g., ["COMPANY-K8S", "MT-K8S"])
                  Supports multiple prefixes for multi-tenant scenarios
                items:
                  type: string
                minItems: 1
                type: array
              roleMapping:
                additionalProperties:
                  type: string
                description: RoleMapping defines mapping of role names to existing
                  ClusterRoles
                type: object
              serviceAccountMapping:
                additionalProperties:
                  type: string
                description: |-
                  ServiceAccountMapping defines mapping of service account names to roles
                  Creates ServiceAccounts with pattern defined by serviceAccountNamingPattern
                  Example: "deploy: edit" creates SA with ClusterRole "edit"
                  Default pattern: {namespace}-sa-{name}
                type: object
              serviceAccountNamingPattern:
                default: '{namespace}-sa-{name}'
                description: |-
                  ServiceAccountNamingPattern defines the naming pattern for ServiceAccounts
                  Available variables: {namespace}, {name}
                  Default: {namespace}-sa-{name}
                  Examples:
                    - {namespace}-sa-{name}      -> my-app-sa-deploy
                    - sa-{namespace}-{name}      -> sa-my-app-deploy
                    - {name}-{namespace}         -> deploy-my-app
                    - {namespace}-{name}         -> my-app-deploy
                type: string
            required:
            - configMapName
            - configMapNamespace
            - prefixes
            - roleMapping
            type: object
          status:
            description: PermissionBinderStatus defines the observed state of PermissionBinder
            properties:
              conditions:
                description: Conditions represent the latest available observations
                  of the PermissionBinder's state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              lastNetworkPolicyReconciliation:
                description: LastNetworkPolicyReconciliation tracks the last time
                  periodic NetworkPolicy reconciliation ran
                format: date-time
                type: string
              lastProcessedConfigMapVersion:
                description: LastProcessedConfigMapVersion tracks the last processed
                  ConfigMap version
                type: string
              lastProcessedRoleMappingHash:
                description: |-
                  LastProcessedRoleMappingHash tracks the hash of the last processed role mapping
                  This is used to detect when role mapping changes and trigger reconciliation
                type: string
              networkPolicies:
                description: NetworkPolicies contains the status of Network Policy
                  management for each namespace
                items:
                  description: NetworkPolicyStatus tracks the status of Network Policy
                    management for a namespace
                  properties:
                    createdAt:
                      description: CreatedAt is the timestamp when the PR was created
                      type: string
                    errorMessage:
                      description: ErrorMessage contains error details if state is
                        "error"
                      type: string
                    lastProcessedTemplateHash:
                      description: |-
                        LastProcessedTemplateHash is the hash of the last processed template directory
                        Used to detect template changes
                      type: string
                    lastTemplateCheckTime:
                      description: LastTemplateCheckTime is the timestamp when templates
                        were last checked
                      format: date-time
                      type: string
                    namespace:
                      description: Namespace is the namespace name
                      type: string
                    prBranch:
                      description: PRBranch is the branch name for the PR
                      type: string
                    prNumber:
                      description: PRNumber is the Pull Request number (if applicable)
                      type: integer
                    prUrl:
                      description: PRURL is the URL to the Pull Request
                      type: string
                    removedAt:
                      description: |-
                        RemovedAt is the timestamp when the namespace was removed from whitelist
                        Used for status cleanup after retention period
                      type: string
                    state:
                      description: |-
                        State is the current state of Network Policy management
                        Possible values: "pr-created", "pr-pending", "pr-merged", "pr-conflict", "pr-stale", "pr-removal", "error", "removed"
                      type: string
                  required:
                  - namespace
                  - state
                  type: object
                type: array
              processedRoleBindings:
                description: ProcessedRoleBindings contains the list of successfully
                  created RoleBindings
                items:
                  type: string
                type: array
              processedServiceAccounts:
                description: ProcessedServiceAccounts contains the list of successfully
                  created ServiceAccounts
                items:
                  type: string
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
    control-plane: controller-manager
  name: permissions-binder-operator
---
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-controller-manager
  namespace: permissions-binder-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-leader-election-role
  namespace: permissions-binder-operator
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders/finalizers
  verbs:
  - update
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterroles
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - rolebindings
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator-metrics-auth-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator-metrics-reader
rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-permissionbinder-editor-role
rules:
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-permissionbinder-viewer-role
rules:
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - permission.permission-binder.io
  resources:
  - permissionbinders/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-leader-election-rolebinding
  namespace: permissions-binder-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: operator-leader-election-role
subjects:
- kind: ServiceAccount
  name: operator-controller-manager
  namespace: permissions-binder-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
  name: operator-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: operator-controller-manager
  namespace: permissions-binder-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: operator-metrics-auth-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: operator-metrics-auth-role
subjects:
- kind: ServiceAccount
  name: operator-controller-manager
  namespace: permissions-binder-operator
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: permission-binder-operator
    control-plane: controller-manager
  name: operator-controller-manager-metrics-service
  namespace: permissions-binder-operator
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    control-plane: controller-manager
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: operator
    control-plane: controller-manager
  name: operator-controller-manager
  namespace: permissions-binder-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
      labels:
        control-plane: controller-manager
    spec:
      containers:
      - args:
        - --metrics-bind-address=:8080
        - --metrics-secure=false
        - --leader-elect
        - --health-probe-bind-address=:8081
        # Leader election is ENABLED for production safety:
        # - Prevents duplicate reconciliation during rolling updates
        # - Ensures graceful shutdown
        # - Required even for single-replica deployments
        command:
        - /manager
        # Multi-arch image (ARM64 + AMD64)
        # Available tags: v1.6.4, v1.6.3, v1.6.2, v1.6.1, v1.6.0, 1.6.0-rc3, 1.6.0-rc2, 1.5.7, 1.5.6, 1.5.5, 1.5.4, 1.5.3, 1.5.2, 1.5.1, 1.5.0, 1.4.0, 1.3.0, latest
        # Production: use specific version (v1.6.4 - refactored controller)
        # Development: use latest tag with Always pull policy
        image: lukaszbielinski/permission-binder-operator:v1.6.4
        imagePullPolicy: IfNotPresent
        env:
        # Enable debug mode to see detailed reconciliation trigger logging
        # Set to "true" or "1" to enable, "false" or "0" to disable (default: disabled)
        # When enabled, logs will show:
        # - What triggers each reconciliation
        # - ConfigMap version changes
        # - Role mapping hash changes
        # - Reasons for skipping reconciliation
        - name: DEBUG_MODE
          value: "false"
        startupProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 1
          periodSeconds: 1
          timeoutSeconds: 1
          failureThreshold: 10
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 3
        name: manager
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 0
          periodSeconds: 2
          timeoutSeconds: 1
          failureThreshold: 3
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 10m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      securityContext:
        runAsNonRoot: true
      serviceAccountName: operator-controller-manager
      terminationGracePeriodSeconds: 10
